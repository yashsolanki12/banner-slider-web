{% comment %}
  USP Bar App Block
  Can be added to any section that supports blocks in the Shopify theme editor
{% endcomment %}

{% if block.settings.enabled %}
  <div id="usp-bar-container-{{ block.id }}" class="usp-bar-wrapper" data-shop="{{ shop.domain }}" style="display: none;">
    <button class="usp-nav-btn prev" id="usp-prev-btn-{{ block.id }}">
      <img src="{{ 'chevron-left.svg' | asset_url }}" alt="left-arrow" width="20px" height="20px">
    </button>
    <div class="usp-bar-content">
      <div class="usp-bar-slider" id="usp-slider-{{ block.id }}">
        <div class="usp-loading">Loading USP Bar...</div>
      </div>
    </div>
    <button class="usp-nav-btn next" id="usp-next-btn-{{ block.id }}">
      <img src="{{ 'chevron-right.svg' | asset_url }}" alt="right-arrow" width="20px" height="20px">
    </button>
  </div>

  <style>
    #usp-bar-container-{{ block.id }} {
      width: 100%;
      background: {{ block.settings.background_color }};
      padding: 15px 20px;
      box-sizing: border-box;
      position: relative;
      overflow: hidden;
      z-index: 1000;
    }

    #usp-bar-container-{{ block.id }} .usp-bar-content {
      width: 100%;
      position: relative;
    }

    #usp-bar-container-{{ block.id }} .usp-bar-slider {
      padding: 0 45px;
      box-sizing: border-box;
      display: flex;
      justify-content: center;
      min-height: 80px;
    }

    @media (max-width: 768px) {
      #usp-bar-container-{{ block.id }} .usp-bar-slider {
        padding: 0 35px;
        min-height: 70px;
      }
    }

    @media (max-width: 480px) {
      #usp-bar-container-{{ block.id }} .usp-bar-slider {
        padding: 0 25px;
        min-height: 60px;
      }
    }

    @media (max-width: 320px) {
      #usp-bar-container-{{ block.id }} .usp-bar-slider {
        padding: 0 25px;
        min-height: 60px;
      }
    }

    #usp-bar-container-{{ block.id }} .usp-items-wrapper {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
      width: 100%;
    }

    #usp-bar-container-{{ block.id }} .usp-item {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      box-sizing: border-box;
      width: 100%;
      max-width: 300px;
      min-width: 250px;
      padding: 0px 10px;
      position: relative;
      min-height: 60px;
    }

    #usp-bar-container-{{ block.id }} .usp-item:not(:last-child)::after {
      content: '';
      position: absolute;
      right: -10px;
      top: 50%;
      transform: translateY(-50%);
      width: 3px;
      height: 30px;
      background-color: #000000;
    }

    #usp-bar-container-{{ block.id }} .usp-item-inner {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 15px;
    }

    #usp-bar-container-{{ block.id }} .usp-item-icon {
      width: 35px;
      height: 35px;
      min-width: 35px;
      min-height: 35px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: {{ block.settings.icon_background_color }};
      border-radius: 50%;
      color: {{ block.settings.icon_color }};
      font-size: 12px;
      font-weight: bold;
      flex-shrink: 0;
    }
    
    #usp-bar-container-{{ block.id }} .usp-item-icon img {
      filter: brightness(0) invert(1);
    }

    #usp-bar-container-{{ block.id }} .usp-item-content {
      display: flex;
      flex-direction: column;
      overflow: hidden;
      flex: 1;
      min-width: 0;
    }

    #usp-bar-container-{{ block.id }} .usp-item-title {
      font-weight: 600;
      font-size: 16px;
      color: {{ block.settings.title_color }};
      margin: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 180px;
      flex-shrink: 1;
    }

    #usp-bar-container-{{ block.id }} .usp-item-description {
      font-size: 14px;
      color: {{ block.settings.description_color }};
      margin: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 180px;
      flex-shrink: 1;
    }

    #usp-bar-container-{{ block.id }} .usp-loading {
      text-align: center;
      color: #333333;
      padding: 10px;
      width: 100%;
    }

    #usp-bar-container-{{ block.id }} .usp-error {
      text-align: center;
      color: #e74c3c;
      padding: 10px;
      width: 100%;
    }

    #usp-bar-container-{{ block.id }} .usp-empty {
      text-align: center;
      color: #333333;
      padding: 10px;
      width: 100%;
    }

    /* Slider navigation */
    #usp-bar-container-{{ block.id }} .usp-nav-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      border: 1px solid #ddd;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: {{ block.settings.title_color }};
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
      z-index: 10;
      transition: all 0.2s ease;
    }

    #usp-bar-container-{{ block.id }} .usp-nav-btn:hover {
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }

    #usp-bar-container-{{ block.id }} .usp-nav-btn.prev {
      left: 5px;
    }

    #usp-bar-container-{{ block.id }} .usp-nav-btn.next {
      right: 5px;
    }

    #usp-bar-container-{{ block.id }}.has-slider .usp-nav-btn {
      display: flex;
    }

    /* Responsive */
    @media (max-width: 768px) {
      #usp-bar-container-{{ block.id }} {
        padding: 10px 40px;
      }
      
      #usp-bar-container-{{ block.id }} .usp-items-wrapper {
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
      }
      
      #usp-bar-container-{{ block.id }} .usp-item {
        padding: 8px 12px;
        min-width: 200px;
        max-width: 250px;
        min-height: 50px;
      }
      
      #usp-bar-container-{{ block.id }} .usp-item-title {
        font-size: 12px;
        max-width: 140px;
        line-height: 1.3;
      }
      
      #usp-bar-container-{{ block.id }} .usp-item-description {
        font-size: 10px;
        max-width: 140px;
        line-height: 1.2;
      }

      #usp-bar-container-{{ block.id }} .usp-item-icon {
        width: 28px;
        height: 28px;
        min-width: 28px;
        min-height: 28px;
        font-size: 10px;
      }

      #usp-bar-container-{{ block.id }} .usp-nav-btn {
        width: 28px;
        height: 28px;
        min-width: 28px;
        font-size: 16px;
      }
    }

    @media (max-width: 480px) {
      #usp-bar-container-{{ block.id }} .usp-bar-slider {
        padding: 0 30px;
        min-height: 60px;
      }
      
      #usp-bar-container-{{ block.id }} .usp-items-wrapper {
        grid-template-columns: 1fr;
        gap: 10px;
        width: 100%;
      }
      
      #usp-bar-container-{{ block.id }} .usp-item {
        min-width: 100%;
        max-width: 100%;
        min-height: 45px;
        width: 100%;
        padding: 8px 10px;
      }
      
      #usp-bar-container-{{ block.id }} .usp-item-title {
        font-size: 11px;
        max-width: 160px;
        line-height: 1.3;
      }
      
      #usp-bar-container-{{ block.id }} .usp-item-description {
        font-size: 9px;
        max-width: 160px;
        line-height: 1.2;
      }

      #usp-bar-container-{{ block.id }} .usp-item-icon {
        width: 24px;
        height: 24px;
        min-width: 24px;
        min-height: 24px;
        font-size: 9px;
      }

      #usp-bar-container-{{ block.id }} .usp-nav-btn {
        width: 24px;
        height: 24px;
        min-width: 24px;
        font-size: 14px;
      }
      
      #usp-bar-container-{{ block.id }} .usp-nav-btn.prev {
        left: 5px;
      }
      
      #usp-bar-container-{{ block.id }} .usp-nav-btn.next {
        right: 5px;
      }
    }

    @media (max-width: 320px) {
      #usp-bar-container-{{ block.id }} {
        padding: 10px 30px;
      }
      
      #usp-bar-container-{{ block.id }} .usp-bar-slider {
        padding: 0 25px;
        min-height: 60px;
      }
      
      #usp-bar-container-{{ block.id }} .usp-item {
        padding: 8px 10px;
        min-height: 45px;
      }
      
      #usp-bar-container-{{ block.id }} .usp-item-title {
        font-size: 12px;
        max-width: 140px;
        line-height: 1.3;
      }
      
      #usp-bar-container-{{ block.id }} .usp-item-description {
        font-size: 10px;
        max-width: 140px;
        line-height: 1.2;
      }

      #usp-bar-container-{{ block.id }} .usp-item-icon {
        width: 28px;
        height: 28px;
        min-width: 28px;
        min-height: 28px;
        font-size: 12px;
      }

      #usp-bar-container-{{ block.id }} .usp-nav-btn {
        width: 28px;
        height: 28px;
        min-width: 28px;
        font-size: 16px;
      }
      
      #usp-bar-container-{{ block.id }} .usp-nav-btn.prev {
        left: 5px;
      }
      
      #usp-bar-container-{{ block.id }} .usp-nav-btn.next {
        right: 5px;
      }
    }
  </style>

  <script>
    (function() {
      const blockId = '{{ block.id }}';
      const shop = '{{ shop.domain }}';
      const apiUrl = 'https://banner-slider-backend.onrender.com';
      
      let allItems = [];
      let currentIndex = 0;
      let itemsPerView = calculateItemsPerView();
      let autoSlideInterval = null;
      let designSettings = null;

      const defaultDesignSettings = {
        backgroundColor: '{{ block.settings.background_color }}',
        titleColor: '{{ block.settings.title_color }}',
        descriptionColor: '{{ block.settings.description_color }}',
        iconBackgroundColor: '{{ block.settings.icon_background_color }}',
        iconColor: '{{ block.settings.icon_color }}',
        slideSpeed: {{ block.settings.slide_speed }},
        itemBorderRightColor: "#000000"
      };

      function calculateItemsPerView() {
        if (window.innerWidth <= 320) {
          return 1;
        } else if (window.innerWidth <= 480) {
          return 1;
        } else if (window.innerWidth <= 768) {
          return 3;
        } else {
          return 4;
        }
      }

      function handleResize() {
        const newItemsPerView = calculateItemsPerView();
        if (newItemsPerView !== itemsPerView) {
          itemsPerView = newItemsPerView;
          currentIndex = 0;
          renderUspBar();
        }
      }

      window.addEventListener('resize', handleResize);

      async function fetchUspBarData() {
        const slider = document.getElementById('usp-slider-' + blockId);
        const container = document.getElementById('usp-bar-container-' + blockId);
        
        try {
          const response = await fetch(`${apiUrl}/api/usp-slider/public/${shop}`);
          const result = await response.json();
          
          if (result.success && result.data && result.data.length > 0) {
            allItems = result.data;
            designSettings = allItems[0].designSettings || defaultDesignSettings;
            applyDesignSettings(container);
            itemsPerView = calculateItemsPerView();
            renderUspBar();
            container.style.display = 'block';
          } else {
            slider.innerHTML = '<div class="usp-empty">No USP items to display</div>';
            container.style.display = 'block';
          }
        } catch (error) {
          console.error('Error fetching USP Bar data:', error);
          slider.innerHTML = '<div class="usp-error">Failed to load USP Bar</div>';
          container.style.display = 'block';
        }
      }

      function renderUspBar() {
        const container = document.getElementById('usp-bar-container-' + blockId);
        itemsPerView = calculateItemsPerView();
        const hasSlider = allItems.length > itemsPerView;
        
        if (hasSlider) {
          container.classList.add('has-slider');
          renderSliderView();
          startAutoSlide();
        } else {
          container.classList.remove('has-slider');
          renderStaticView();
        }
      }

      function applyDesignSettings(container) {
        const settings = designSettings || defaultDesignSettings;
        
        container.style.backgroundColor = settings.backgroundColor;
        
        const styleEl = document.createElement('style');
        styleEl.id = 'usp-bar-dynamic-styles-' + blockId;
        styleEl.textContent = `
          .usp-dot.active {
            background: ${settings.iconBackgroundColor} !important;
          }
          .usp-nav-btn {
            color: ${settings.titleColor} !important;
          } 
          .usp-item:not(:last-child)::after {
            background-color: ${settings.itemBorderRightColor} !important;
          }
        `;
       
        const existingStyles = document.getElementById('usp-bar-dynamic-styles-' + blockId);
        if (existingStyles) {
          existingStyles.remove();
        }
        
        document.head.appendChild(styleEl);
      }

      function renderStaticView() {
        const slider = document.getElementById('usp-slider-' + blockId);
        let html = '<div class="usp-items-wrapper">';
        
        const globalSettings = designSettings || defaultDesignSettings;
        
        allItems.forEach((item, index) => {
          const itemSettings = item.designSettings || defaultDesignSettings;
          html += `
            <div class="usp-item">
               <div class="usp-item-icon" style="background: ${itemSettings.iconBackgroundColor}; color: ${itemSettings.iconColor};">${item.icon ? `<img src="${item.icon}" alt="Icon" style="width: 22px !important; height: 22px !important; object-fit: contain; filter: ${hexToRgb(itemSettings.iconColor) ? `brightness(0) saturate(100%) invert(${hexToRgb(itemSettings.iconColor).r}%) sepia(0%) saturate(0%) hue-rotate(0deg) brightness(100%) contrast(100%)` : 'brightness(0) invert(1)'};">` : '✓'}</div>
              <div class="usp-item-content">
                <p class="usp-item-title" style="color: ${itemSettings.titleColor};">${escapeHtml(item.title)}</p>
                <p class="usp-item-description" style="color: ${itemSettings.descriptionColor};">${escapeHtml(item.description)}</p>
              </div>
            </div>
          `;
        });

        html += '</div>';
        slider.innerHTML = html;
      }

      function renderSliderView() {
        const slider = document.getElementById('usp-slider-' + blockId);
        const container = document.getElementById('usp-bar-container-' + blockId);
        let html = '<div class="usp-items-wrapper">';
        
        const globalSettings = designSettings || defaultDesignSettings;
        
        const visibleItems = getVisibleItems();
        visibleItems.forEach((item, index) => {
          const itemSettings = item.designSettings || defaultDesignSettings;
          html += `
            <div class="usp-item">
               <div class="usp-item-icon" style="background: ${itemSettings.iconBackgroundColor}; color: ${itemSettings.iconColor};">${item.icon ? `<img src="${item.icon}" alt="Icon" style="width: 16px; height: 16px; object-fit: contain; filter: ${hexToRgb(itemSettings.iconColor) ? `brightness(0) saturate(100%) invert(${hexToRgb(itemSettings.iconColor).r}%) sepia(0%) saturate(0%) hue-rotate(0deg) brightness(100%) contrast(100%)` : 'brightness(0) invert(1)'};">` : '✓'}</div>
              <div class="usp-item-content">
                <p class="usp-item-title" style="color: ${itemSettings.titleColor};">${escapeHtml(item.title)}</p>
                <p class="usp-item-description" style="color: ${itemSettings.descriptionColor};">${escapeHtml(item.description)}</p>
              </div>
            </div>
          `;
        });

        html += '</div>';

        slider.innerHTML = html;

        setupNavigation(container);
      }

      function getVisibleItems() {
        const start = currentIndex * itemsPerView;
        const end = Math.min(start + itemsPerView, allItems.length);
        return allItems.slice(start, end);
      }

      function setupNavigation(container) {
        const prevBtn = document.getElementById('usp-prev-btn-' + blockId);
        const nextBtn = document.getElementById('usp-next-btn-' + blockId);
        
        prevBtn.onclick = () => slideDirection(-1);
        nextBtn.onclick = () => slideDirection(1);
      }

      function slideDirection(direction) {
        const totalSlides = Math.ceil(allItems.length / itemsPerView);
        currentIndex += direction;
        
        if (currentIndex < 0) currentIndex = totalSlides - 1;
        if (currentIndex >= totalSlides) currentIndex = 0;
        
        updateSlider();
      }

      function goToSlide(index) {
        currentIndex = index;
        updateSlider();
      }

      function updateSlider() {
        const slider = document.getElementById('usp-slider-' + blockId);
        const visibleItems = getVisibleItems();
        const wrapper = slider.querySelector('.usp-items-wrapper');
        
        const globalSettings = designSettings || defaultDesignSettings;
        
        let html = '';
        visibleItems.forEach((item, index) => {
          const itemSettings = item.designSettings || defaultDesignSettings;
          html += `
            <div class="usp-item">
               <div class="usp-item-icon" style="background: ${itemSettings.iconBackgroundColor}; color: ${itemSettings.iconColor};">${item.icon ? `<img src="${item.icon}" alt="Icon" style="width: 16px; height: 16px; object-fit: contain; filter: ${hexToRgb(itemSettings.iconColor) ? `brightness(0) saturate(100%) invert(${hexToRgb(itemSettings.iconColor).r}%) sepia(0%) saturate(0%) hue-rotate(0deg) brightness(100%) contrast(100%)` : 'brightness(0) invert(1)'};">` : '✓'}</div>
              <div class="usp-item-content">
                <p class="usp-item-title" style="color: ${itemSettings.titleColor};">${escapeHtml(item.title)}</p>
                <p class="usp-item-description" style="color: ${itemSettings.descriptionColor};">${escapeHtml(item.description)}</p>
              </div>
            </div>
          `;
        });
        
        wrapper.innerHTML = html;
      }

      function startAutoSlide() {
        const settings = designSettings || defaultDesignSettings;
        const slideSpeed = (settings.slideSpeed || 4) * 1000;
        autoSlideInterval = setInterval(() => {
          slideDirection(1);
        }, slideSpeed);
      }

      function hexToRgb(hex) {
        const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result ? {
          r: parseInt(result[1], 16),
          g: parseInt(result[2], 16),
          b: parseInt(result[3], 16)
        } : null;
      }

      function escapeHtml(text) {
        const map = {
          '&': '&',
          '<': '<',
          '>': '>',
          '"': '"',
          "'": '&#039;'
        };

        return text.replace(/[&<>"]/g, function(m) { return map[m]; });
      }

      document.addEventListener('DOMContentLoaded', function() {
        fetchUspBarData();
      });
    })();
  </script>
{% endif %}

{% schema %}
  {
    "name": "USP Bar",
    "target": "section",
    "settings": [
      {
        "type": "header",
        "content": "Display Settings"
      },
      {
        "type": "checkbox",
        "id": "enabled",
        "label": "Enable USP Bar",
        "default": true
      },
      {
        "type": "header",
        "content": "Design Settings"
      },
      {
        "type": "color",
        "id": "background_color",
        "label": "Bar Background Color",
        "default": "#f8f9fa"
      },
      {
        "type": "color",
        "id": "title_color",
        "label": "Title Color",
        "default": "#333333"
      },
      {
        "type": "color",
        "id": "description_color",
        "label": "Description Color",
        "default": "#666666"
      },
      {
        "type": "color",
        "id": "icon_background_color",
        "label": "Icon Background Color",
        "default": "#4CAF50"
      },
      {
        "type": "color",
        "id": "icon_color",
        "label": "Icon Color",
        "default": "#ffffff"
      },
      {
        "type": "header",
        "content": "Slider Settings"
      },
      {
        "type": "range",
        "id": "slide_speed",
        "label": "Slide Speed (seconds)",
        "default": 4,
        "min": 1,
        "max": 10,
        "step": 1
      }
    ]
  }
{% endschema %}
